<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üç™ Cookie Authentication Test</h1>
    
    <div class="container info">
        <h3>üìã Test Instructions</h3>
        <p>This page tests HTTP-only cookie authentication from your frontend domain.</p>
        <p><strong>Backend:</strong> https://projectwork-be.onrender.com</p>
        <p><strong>Frontend:</strong> https://project-work-fe.vercel.app</p>
        <p><strong>Current Domain:</strong> <span id="currentDomain"></span></p>
    </div>

    <div class="step">
        <h3>Step 1: Test Login with HTTP-only Cookies</h3>
        <div>
            <input type="email" id="email" placeholder="Email" value="mammt@gmail.com">
            <input type="password" id="password" placeholder="Password" value="qyfpyj-dytnym-jeJqy4">
            <button class="btn-primary" onclick="testLogin()">Test Login</button>
        </div>
        <div id="loginResult"></div>
    </div>

    <div class="step">
        <h3>Step 2: Test Authenticated Request (Cookie-based)</h3>
        <button class="btn-success" onclick="testUserWithCookies()">Test User with Cookies</button>
        <div id="userResult"></div>
    </div>

    <div class="step">
        <h3>Step 3: Check Browser Cookies</h3>
        <button class="btn-primary" onclick="inspectCookies()">Inspect Cookies</button>
        <div id="cookieResult"></div>
    </div>

    <div class="step">
        <h3>Step 4: Test CORS Preflight</h3>
        <button class="btn-primary" onclick="testCorsPreflight()">Test CORS Preflight</button>
        <div id="corsResult"></div>
    </div>

    <script>
        const API_BASE = 'https://projectwork-be.onrender.com/api/v1';
        
        // Set current domain
        document.getElementById('currentDomain').textContent = window.location.origin;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}"><pre>${message}</pre></div>`;
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                showResult('loginResult', 'üîÑ Logging in...', 'info');
                
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    credentials: 'include', // CRITICAL: This enables cookies
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult('loginResult', 
                        `‚úÖ Login Successful!\n\n` +
                        `Status: ${response.status}\n` +
                        `Token Type: ${data.token_type}\n` +
                        `Expires In: ${data.expires_in} seconds\n` +
                        `Access Token: ${data.access_token.substring(0, 50)}...\n` +
                        `Refresh Token: ${data.refresh_token.substring(0, 50)}...\n\n` +
                        `Cookie Fallback Available: ${data.cookie_fallback ? 'Yes' : 'No'}\n` +
                        `HTTP-only cookies should be set automatically.`, 
                        'success'
                    );
                } else {
                    showResult('loginResult', 
                        `‚ùå Login Failed!\n\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('loginResult', 
                    `‚ùå Network Error!\n\n` +
                    `Error: ${error.message}\n` +
                    `This might be a CORS issue.`, 
                    'error'
                );
            }
        }

        async function testUserWithCookies() {
            try {
                showResult('userResult', 'üîÑ Testing user with cookies...', 'info');
                
                const response = await fetch(`${API_BASE}/test-user`, {
                    method: 'GET',
                    credentials: 'include', // This sends cookies
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult('userResult', 
                        `‚úÖ Cookie Authentication Working!\n\n` +
                        `Status: ${response.status}\n` +
                        `User Authenticated: ${data.user_authenticated}\n` +
                        `User ID: ${data.user_id}\n` +
                        `User Email: ${data.user_email}\n` +
                        `Message: ${data.message}`, 
                        'success'
                    );
                } else {
                    showResult('userResult', 
                        `‚ùå Cookie Authentication Failed!\n\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('userResult', 
                    `‚ùå Network Error!\n\n` +
                    `Error: ${error.message}`, 
                    'error'
                );
            }
        }

        function inspectCookies() {
            const cookies = document.cookie;
            if (cookies) {
                showResult('cookieResult', 
                    `üç™ Current Cookies:\n\n${cookies}\n\n` +
                    `Cookie Count: ${cookies.split(';').length}\n` +
                    `Has access_token: ${cookies.includes('access_token')}\n` +
                    `Has refresh_token: ${cookies.includes('refresh_token')}\n\n` +
                    `Note: HTTP-only cookies won't be visible here!`, 
                    'info'
                );
            } else {
                showResult('cookieResult', '‚ùå No cookies found!', 'error');
            }
        }

        async function testCorsPreflight() {
            try {
                showResult('corsResult', 'üîÑ Testing CORS preflight...', 'info');
                
                const response = await fetch(`${API_BASE}/test-user`, {
                    method: 'OPTIONS',
                    credentials: 'include',
                    headers: {
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type',
                    }
                });

                showResult('corsResult', 
                    `‚úÖ CORS Preflight Response!\n\n` +
                    `Status: ${response.status}\n` +
                    `Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 
                    'success'
                );
            } catch (error) {
                showResult('corsResult', 
                    `‚ùå CORS Preflight Failed!\n\n` +
                    `Error: ${error.message}`, 
                    'error'
                );
            }
        }

        // Auto-inspect cookies on page load
        window.onload = function() {
            inspectCookies();
        };
    </script>
</body>
</html>
